name: Deploy to Apigee Edge

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install jq -y

    - name: Zip the Apigee Proxy
      run: |
        cd apiproxy
        zip -r ../proxy.zip .
        cd ..

    - name: Deploy Proxy to Apigee Edge
      run: |
        PROXY_NAME=Oauth-OGV

        echo "Uploading proxy revision..."
        curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
          -X POST \
          -H "Content-Type: multipart/form-data" \
          -F "file=@proxy.zip" \
          "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/apis?action=import&name=$PROXY_NAME"

        echo "Getting latest revision..."
        REV=$(curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
          "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/apis/$PROXY_NAME" \
          | jq '.revision | last')

        echo "Deploying revision $REV ..."
        curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
          -X POST \
          "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/environments/${{ secrets.APIGEE_ENV }}/apis/$PROXY_NAME/revisions/$REV/deployments?override=true"

        echo "Deployed revision $REV to ${{ secrets.APIGEE_ENV }}"
