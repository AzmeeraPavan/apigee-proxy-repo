name: Deploy to Apigee Edge

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Zip the Apigee Proxy
      run: |
        cd apiproxy
        zip -r ../proxy.zip .

    - name: Deploy Proxy to Apigee Edge
      run: |
        PROXY_NAME=Oauth-OGV
        VERSION=$(date +%s)

        echo "Uploading proxy revision..."
        curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
          -X POST \
          -H "Content-Type: multipart/form-data" \
          -F "file=@proxy.zip" \
          "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/apis?action=import&name=$PROXY_NAME"

        echo "Deploying to environment..."
        REV=$(curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
            "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/apis/$PROXY_NAME" \
            | jq '.revision | last')

        curl -u "${{ secrets.APIGEE_USERNAME }}:${{ secrets.APIGEE_PASSWORD }}" \
          -X POST \
          "https://api.enterprise.apigee.com/v1/organizations/${{ secrets.APIGEE_ORG }}/environments/${{ secrets.APIGEE_ENV }}/apis/$PROXY_NAME/revisions/$REV/deployments?override=true"

        echo "Deployed revision $REV to ${{ secrets.APIGEE_ENV }}"
